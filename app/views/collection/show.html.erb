<div class="max-w-7xl mx-auto px-4 py-8">
  <%# Header with title, tabs, breadcrumb %>
  <div class="flex items-center justify-between mb-8">
    <div class="flex items-center gap-6">
      <h1 class="text-2xl font-bold text-crusta-400 tracking-wide uppercase">
        Crates
      </h1>

      <nav class="flex items-center gap-1">
        <%= link_to crates_path(username: @user.username, tab: "collection", view: @view),
                    class: "px-4 py-1.5 text-sm font-medium rounded-sm transition-colors #{@tab == 'collection' ? 'bg-woodsmoke-800 text-woodsmoke-50' : 'text-woodsmoke-400 hover:text-woodsmoke-200'}" do %>
          Collection
        <% end %>

        <%= link_to crates_path(username: @user.username, tab: "wantlist", view: @view),
                    class: "px-4 py-1.5 text-sm font-medium rounded-sm transition-colors #{@tab == 'wantlist' ? 'bg-woodsmoke-800 text-woodsmoke-50' : 'text-woodsmoke-400 hover:text-woodsmoke-200'}" do %>
          Wantlist
          <span class="text-woodsmoke-500"><%= @wantlist_count %></span>
        <% end %>

        <%= link_to crates_path(username: @user.username, tab: "trade_list", view: @view),
                    class: "px-4 py-1.5 text-sm font-medium rounded-sm transition-colors #{@tab == 'trade_list' ? 'bg-woodsmoke-800 text-woodsmoke-50' : 'text-woodsmoke-400 hover:text-woodsmoke-200'}" do %>
          Trade List
          <span class="text-woodsmoke-500"><%= @trade_list_count %></span>
        <% end %>

        <%= link_to crates_path(username: @user.username, tab: "history"),
                    class: "px-4 py-1.5 text-sm font-medium rounded-sm transition-colors #{@tab == 'history' ? 'bg-woodsmoke-800 text-woodsmoke-50' : 'text-woodsmoke-400 hover:text-woodsmoke-200'}" do %>
          History
        <% end %>
      </nav>
    </div>

    <div class="flex items-center gap-4">
      <% if Current.user == @user %>
        <%= link_to new_collection_import_path(username: @user.username),
                    class: "px-4 py-1.5 text-sm font-semibold rounded-sm border border-crusta-500/40 text-crusta-400 hover:bg-crusta-500/10 transition-colors" do %>
          Import CSV
        <% end %>
      <% end %>

      <div class="text-sm text-woodsmoke-500">
        <%= link_to "Home", root_path, class: "hover:text-crusta-400 transition-colors" %>
        <span class="mx-1">/</span>
        <%= link_to @user.username, crates_path(username: @user.username), class: "hover:text-crusta-400 transition-colors" %>
        <span class="mx-1">/</span>

        <span class="text-woodsmoke-300">
          <%= { "collection" => "Collection", "wantlist" => "Wantlist", "trade_list" => "Trade List", "history" => "History" }[@tab] %>
        </span>
      </div>
    </div>
  </div>

  <% if @tab == "history" %>
    <%= render "collection/history" %>
  <% else %>
    <%# Stats cards %>
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
      <div class="p-4 rounded-sm border border-woodsmoke-800 bg-woodsmoke-925">
        <p
          class="
            text-xs font-semibold uppercase tracking-wider
            text-woodsmoke-400 mb-1
          "
        >
          Total Records
        </p>

        <p class="text-3xl font-bold text-crusta-400"><%= @total_records %></p>

        <p class="text-xs text-woodsmoke-500 mt-1">
          <%= @artist_count %> artists
        </p>
      </div>

      <div class="p-4 rounded-sm border border-woodsmoke-800 bg-woodsmoke-925">
        <p
          class="
            text-xs font-semibold uppercase tracking-wider
            text-woodsmoke-400 mb-1
          "
        >
          Labels
        </p>

        <p class="text-3xl font-bold text-crusta-400"><%= @label_count %></p>
      </div>

      <div class="p-4 rounded-sm border border-woodsmoke-800 bg-woodsmoke-925">
        <% top_format = @format_summary.max_by { |_, qty| qty } %>

        <p
          class="
            text-xs font-semibold uppercase tracking-wider
            text-woodsmoke-400 mb-1
          "
        >
          <%= top_format&.first || 'Formats' %>
        </p>

        <p class="text-3xl font-bold text-crusta-400">
          <%= top_format&.last || 0 %>
        </p>

        <p class="text-xs text-woodsmoke-500 mt-1">
          of <%= @total_records %> total
        </p>
      </div>

      <div class="p-4 rounded-sm border border-woodsmoke-800 bg-woodsmoke-925">
        <p
          class="
            text-xs font-semibold uppercase tracking-wider
            text-woodsmoke-400 mb-1
          "
        >
          Colored Vinyl
        </p>

        <p class="text-3xl font-bold text-crusta-400">
          <%= @colored_vinyl_count %>
        </p>

        <p class="text-xs text-woodsmoke-500 mt-1">
          of <%= @total_records %> total
        </p>
      </div>
    </div>
    <%# Search + Sort bar + View toggle %>
    <div class="flex flex-wrap items-center gap-4 mb-4">
      <%= form_with url: crates_path(username: @user.username), method: :get, class: "flex-shrink-0" do |f| %>
        <%= f.hidden_field :tab, value: @tab %>
        <%= f.hidden_field :sort, value: @sort %>
        <%= f.hidden_field :view, value: @view %>

        <%= f.text_field :q, value: params[:q], placeholder: "Search collection...",
            autocomplete: "off",
            class: "rounded-sm border border-woodsmoke-700 bg-woodsmoke-925 px-3 py-2 text-sm text-woodsmoke-50 placeholder-woodsmoke-500 focus:border-crusta-400 focus:ring-1 focus:ring-crusta-400 focus:outline-none w-48" %>
      <% end %>

      <div class="flex items-center gap-2">
        <span class="text-xs text-woodsmoke-500 uppercase tracking-wider">
          Sort
        </span>

        <% %w[artist title year label added].each do |sort_key| %>
          <%= link_to sort_key.upcase,
                    crates_path(username: @user.username, tab: @tab, sort: sort_key, label: @label_filter, q: params[:q], view: @view),
                    class: "px-3 py-1 text-xs font-semibold rounded-sm border transition-colors #{@sort == sort_key ? 'border-crusta-400 text-crusta-400' : 'border-woodsmoke-700 text-woodsmoke-400 hover:border-woodsmoke-500 hover:text-woodsmoke-200'}" %>
        <% end %>
      </div>

      <div class="ml-auto flex items-center gap-1">
        <%= link_to crates_path(username: @user.username, tab: @tab, sort: @sort, label: @label_filter, q: params[:q], view: "list"),
                  class: "p-2 rounded-sm border transition-colors #{@view == 'list' ? 'border-crusta-400 text-crusta-400' : 'border-woodsmoke-700 text-woodsmoke-500 hover:border-woodsmoke-500 hover:text-woodsmoke-300'}" do %>
          <svg
            class="w-4 h-4"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            viewBox="0 0 24 24"
          >
            <path stroke-linecap="round" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        <% end %>

        <%= link_to crates_path(username: @user.username, tab: @tab, sort: @sort, label: @label_filter, q: params[:q], view: "grid"),
                  class: "p-2 rounded-sm border transition-colors #{@view == 'grid' ? 'border-crusta-400 text-crusta-400' : 'border-woodsmoke-700 text-woodsmoke-500 hover:border-woodsmoke-500 hover:text-woodsmoke-300'}" do %>
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
            <path
              d="M3 3h8v8H3V3zm10 0h8v8h-8V3zM3 13h8v8H3v-8zm10 0h8v8h-8v-8z"
            />
          </svg>
        <% end %>
      </div>
    </div>
    <%# Label filter chips â€” show top labels by record count, overflow behind toggle %>
    <% if @labels.any? %>
      <% max_visible = 15 %>
      <% visible_labels = @labels.first(max_visible) %>
      <% overflow_labels = @labels.drop(max_visible) %>
      <%# If the active filter is in the overflow, always include it in visible %>
      <% if @label_filter.present? && overflow_labels.include?(@label_filter) %>
        <% overflow_labels.delete(@label_filter) %>
        <% visible_labels << @label_filter %>
      <% end %>
      <div
        class="flex flex-wrap items-center gap-2 mb-4"
        data-controller="collapsible"
      >
        <span class="text-xs text-woodsmoke-500 uppercase tracking-wider">
          Label
        </span>

        <%= link_to "ALL",
                  crates_path(username: @user.username, tab: @tab, sort: @sort, q: params[:q], view: @view),
                  class: "px-3 py-1 text-xs font-semibold rounded-sm border transition-colors #{@label_filter.blank? ? 'border-crusta-400 text-crusta-400' : 'border-woodsmoke-700 text-woodsmoke-400 hover:border-woodsmoke-500 hover:text-woodsmoke-200'}" %>

        <% visible_labels.each do |label_name| %>
          <%= link_to label_name.upcase,
                    crates_path(username: @user.username, tab: @tab, sort: @sort, label: label_name, q: params[:q], view: @view),
                    class: "px-3 py-1 text-xs font-semibold rounded-sm border transition-colors #{@label_filter == label_name ? 'border-crusta-400 text-crusta-400' : 'border-woodsmoke-700 text-woodsmoke-400 hover:border-woodsmoke-500 hover:text-woodsmoke-200'}" %>
        <% end %>

        <% if overflow_labels.any? %>
          <button
            data-action="collapsible#toggle"
            class="
              px-3 py-1 text-xs font-semibold rounded-sm border
              border-woodsmoke-700 text-woodsmoke-500
              hover:border-woodsmoke-500 hover:text-woodsmoke-300
              transition-colors
            "
          >
            +
            <%= overflow_labels.size %>
            more
            <svg
              data-collapsible-target="icon"
              class="inline w-3 h-3 ml-0.5 transition-transform"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M19 9l-7 7-7-7"
              />
            </svg>
          </button>
          <div
            data-collapsible-target="content"
            class="hidden flex flex-wrap items-center gap-2 w-full"
          >
            <% overflow_labels.each do |label_name| %>
              <%= link_to label_name.upcase,
                        crates_path(username: @user.username, tab: @tab, sort: @sort, label: label_name, q: params[:q], view: @view),
                        class: "px-3 py-1 text-xs font-semibold rounded-sm border transition-colors #{@label_filter == label_name ? 'border-crusta-400 text-crusta-400' : 'border-woodsmoke-700 text-woodsmoke-400 hover:border-woodsmoke-500 hover:text-woodsmoke-200'}" %>
            <% end %>
          </div>
        <% end %>
      </div>
    <% end %>
    <%# Record count %>
    <p class="text-sm text-woodsmoke-500 mb-4"><%= @pagy.count %> records</p>
    <%# Items %>
    <% if @items.any? %>
      <% if @view == 'grid' %>
        <div
          class="
            grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5
            gap-4
          "
        >
          <% @items.each do |item| %>
            <%= render "collection/item_card", item: item %>
          <% end %>
        </div>
      <% else %>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b border-woodsmoke-800">
                <th
                  class="
                    text-left py-3 px-2 text-xs font-semibold uppercase
                    tracking-wider text-woodsmoke-500
                  "
                >
                  Artist
                </th>

                <th
                  class="
                    text-left py-3 px-2 text-xs font-semibold uppercase
                    tracking-wider text-woodsmoke-500
                  "
                >
                  Title
                </th>

                <th
                  class="
                    text-left py-3 px-2 text-xs font-semibold uppercase
                    tracking-wider text-woodsmoke-500 hidden md:table-cell
                  "
                >
                  Label
                </th>

                <th
                  class="
                    text-left py-3 px-2 text-xs font-semibold uppercase
                    tracking-wider text-woodsmoke-500 hidden md:table-cell
                  "
                >
                  Year
                </th>

                <th
                  class="
                    text-left py-3 px-2 text-xs font-semibold uppercase
                    tracking-wider text-woodsmoke-500 hidden lg:table-cell
                  "
                >
                  Format
                </th>

                <th
                  class="
                    text-left py-3 px-2 text-xs font-semibold uppercase
                    tracking-wider text-woodsmoke-500 hidden lg:table-cell
                  "
                >
                  Color
                </th>

                <% if @tab == "collection" %>
                  <th
                    class="
                      text-left py-3 px-2 text-xs font-semibold uppercase
                      tracking-wider text-woodsmoke-500 hidden lg:table-cell
                    "
                  >
                    Condition
                  </th>
                <% end %>
              </tr>
            </thead>

            <tbody>
              <% @items.each do |item| %>
                <%= render "collection/item_row", item: item %>
              <% end %>
            </tbody>
          </table>
        </div>
      <% end %>
      <%# Pagination %>
      <% if @pagy.last > 1 %>
        <div class="mt-6 flex items-center justify-center gap-3">
          <span class="text-xs text-woodsmoke-500">
            Page <%= @pagy.page %> of <%= @pagy.last %>
          </span>

          <div class="flex gap-1">
            <% if @pagy.previous %>
              <%= link_to crates_path(username: @user.username, tab: @tab, sort: @sort, label: @label_filter, q: params[:q], view: @view, page: @pagy.previous),
                        class: "px-3 py-1.5 text-sm font-medium rounded-sm border border-woodsmoke-700 text-woodsmoke-200 hover:border-woodsmoke-500 transition-colors" do %>
                &larr; Prev
              <% end %>
            <% end %>

            <% if @pagy.next %>
              <%= link_to crates_path(username: @user.username, tab: @tab, sort: @sort, label: @label_filter, q: params[:q], view: @view, page: @pagy.next),
                        class: "px-3 py-1.5 text-sm font-medium rounded-sm border border-woodsmoke-700 text-woodsmoke-200 hover:border-woodsmoke-500 transition-colors" do %>
                Next &rarr;
              <% end %>
            <% end %>
          </div>
        </div>
      <% end %>
    <% else %>
      <div class="text-center py-16">
        <p class="text-woodsmoke-400 text-lg">
          <% case @tab %>
          <% when "collection" %>
            No releases in your collection yet.
          <% when "wantlist" %>
            Your wantlist is empty.
          <% when "trade_list" %>
            No releases on your trade list.
          <% end %>
        </p>

        <p class="text-woodsmoke-500 text-sm mt-2">
          Browse releases and add them from the release page.
        </p>
      </div>
    <% end %>
  <% end %>
</div>
